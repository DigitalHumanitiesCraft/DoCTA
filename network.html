<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Netzwerk-Explorer | DoCTA</title>
  <meta name="description" content="Interaktiver Beziehungsgraph: 6.288 Personen und 42.893 Relationen aus der SiCProD-Datenbank. Filter, Suche, Detailansicht.">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="lib/bootstrap.min.css">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <a class="skip-link" href="#main">Zum Inhalt springen</a>
  <nav class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
    <div class="container-fluid px-3">
      <a class="navbar-brand" href="index.html">DoCTA</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Navigation umschalten">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav" id="main-nav"></ul>
      </div>
    </div>
  </nav>

  <main id="main">
    <div class="network-page">
      <div class="network-header">
        <h1 class="h5 mb-0">Netzwerk-Explorer</h1>
        <p class="small mb-0 text-body-secondary" id="network-subtitle">Interaktiver Beziehungsgraph basierend auf SiCProD-Daten</p>
      </div>
      <div class="network-toolbar">
        <div class="btn-group btn-group-sm" role="group" aria-label="Netzwerkmodus">
          <button class="btn btn-outline-accent active" id="btn-ego" data-mode="ego">Ego-Netzwerk</button>
          <button class="btn btn-outline-accent" id="btn-full" data-mode="full">Gesamtnetzwerk</button>
        </div>
        <input type="search" id="node-search" placeholder="Person suchen..." aria-label="Knotensuche">
        <select id="filter-reltype" aria-label="Relationstyp filtern">
          <option value="">Alle Relationstypen</option>
        </select>
        <button class="btn btn-outline-secondary btn-sm" id="btn-reset">Ansicht zurücksetzen</button>
      </div>

      <div id="cy"></div>

      <!-- Legend -->
      <div style="position:absolute;bottom:40px;left:12px;background:rgba(255,255,255,0.95);border:1px solid var(--border-light);border-radius:6px;padding:8px 12px;font-size:0.75rem;z-index:10;line-height:1.8">
        <div style="display:flex;align-items:center;gap:6px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#1565c0"></span> Person</div>
        <div style="display:flex;align-items:center;gap:6px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#2e7d32"></span> Ort</div>
        <div style="display:flex;align-items:center;gap:6px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#e65100"></span> Institution</div>
        <div style="display:flex;align-items:center;gap:6px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#6a1b9a"></span> Funktion</div>
        <div style="margin-top:4px;color:var(--text-muted-custom);font-size:0.6875rem">Knotengröße = Anzahl Verbindungen</div>
        <div style="color:var(--text-muted-custom);font-size:0.6875rem">Klick auf Knoten = Erkunden</div>
      </div>

      <!-- Detail sidebar -->
      <div class="network-sidebar" id="detail-sidebar" style="display:none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h3 class="h6 mb-0" id="sidebar-name"></h3>
          <button class="btn btn-outline-secondary btn-sm" id="btn-close-sidebar" aria-label="Schließen">×</button>
        </div>
        <div id="sidebar-content"></div>
      </div>

      <div class="network-info" id="network-info">
        Laden...
      </div>
    </div>
  </main>

  <script src="lib/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initNav, initBanner, formatNumber } from './js/app.js';
    import { loadAll } from './js/data-loader.js';
    import { getParams, debounce, escapeHTML } from './js/utils.js';

    initNav('network');
    initBanner();

    const DEFAULT_CENTER = 'person-18'; // Sigmund von Tirol
    const EGO_MAX_NEIGHBORS = 50;
    const FULL_MAX_NODES = 75;

    let cy = null;
    let cytoscape = null;
    let entityIndex = {};
    let degree = {};
    let allRelations = [];
    let currentMode = 'ego';
    let currentCenter = DEFAULT_CENTER;

    const cyStyles = [
      {
        selector: 'node',
        style: {
          'label': 'data(label)', 'text-valign': 'bottom', 'text-halign': 'center',
          'font-size': '9px', 'font-family': '-apple-system, sans-serif',
          'text-margin-y': 5, 'text-max-width': '90px', 'text-wrap': 'ellipsis',
        },
      },
      {
        selector: 'node[type="person"]',
        style: {
          'background-color': '#1565c0',
          'width': 'mapData(degree, 1, 200, 12, 40)',
          'height': 'mapData(degree, 1, 200, 12, 40)',
        },
      },
      {
        selector: 'node[type="place"]',
        style: {
          'background-color': '#2e7d32', 'shape': 'diamond',
          'width': 'mapData(degree, 1, 200, 14, 35)',
          'height': 'mapData(degree, 1, 200, 14, 35)',
        },
      },
      {
        selector: 'node[type="institution"]',
        style: {
          'background-color': '#e65100', 'shape': 'round-rectangle',
          'width': 'mapData(degree, 1, 200, 14, 35)',
          'height': 'mapData(degree, 1, 200, 14, 35)',
        },
      },
      {
        selector: 'node[type="function"]',
        style: {
          'background-color': '#6a1b9a', 'shape': 'ellipse',
          'width': 'mapData(degree, 1, 200, 10, 30)',
          'height': 'mapData(degree, 1, 200, 10, 30)',
        },
      },
      {
        selector: 'node[isCenter="yes"]',
        style: {
          'border-width': 3, 'border-color': '#8b5e3c',
          'width': 50, 'height': 50,
          'font-size': '11px', 'font-weight': 'bold',
          'text-max-width': '130px',
        },
      },
      {
        selector: 'edge',
        style: {
          'width': 0.5, 'line-color': '#d4cfc6', 'target-arrow-shape': 'none',
          'curve-style': 'haystack', 'opacity': 0.35,
        },
      },
      { selector: ':selected', style: { 'border-width': 2, 'border-color': '#8b5e3c' } },
      { selector: '.highlighted', style: { 'background-color': '#c62828', 'border-width': 3, 'border-color': '#c62828', 'z-index': 100 } },
      { selector: '.neighbor', style: { 'opacity': 1, 'z-index': 50 } },
      { selector: '.faded', style: { 'opacity': 0.1 } },
    ];

    function buildEgoElements(centerKey) {
      const neighbors = new Map();

      for (const r of allRelations) {
        const srcKey = `${r.subj_type}-${r.subj_id}`;
        const tgtKey = `${r.obj_type}-${r.obj_id}`;

        if (srcKey === centerKey && entityIndex[tgtKey]) {
          if (!neighbors.has(tgtKey)) neighbors.set(tgtKey, new Set());
          neighbors.get(tgtKey).add(r.relation_type);
        }
        if (tgtKey === centerKey && entityIndex[srcKey]) {
          if (!neighbors.has(srcKey)) neighbors.set(srcKey, new Set());
          neighbors.get(srcKey).add(r.relation_type);
        }
      }

      // Top N neighbors by degree
      const sorted = [...neighbors.keys()]
        .sort((a, b) => (degree[b] || 0) - (degree[a] || 0))
        .slice(0, EGO_MAX_NEIGHBORS);

      const addedNodes = new Set();
      const elements = [];
      const relTypeCounts = {};

      // Center node
      const ce = entityIndex[centerKey];
      if (!ce) return { elements: [], relTypeCounts: {} };
      elements.push({ data: { id: centerKey, label: ce.name, type: ce.type, degree: degree[centerKey] || 0, isCenter: 'yes' } });
      addedNodes.add(centerKey);

      // Neighbor nodes
      for (const key of sorted) {
        const e = entityIndex[key];
        if (!e) continue;
        elements.push({ data: { id: key, label: e.name, type: e.type, degree: degree[key] || 0 } });
        addedNodes.add(key);
      }

      // Edges only between actually-added nodes
      for (const r of allRelations) {
        const src = `${r.subj_type}-${r.subj_id}`;
        const tgt = `${r.obj_type}-${r.obj_id}`;
        if (addedNodes.has(src) && addedNodes.has(tgt)) {
          elements.push({ data: { source: src, target: tgt, relType: r.relation_type } });
          relTypeCounts[r.relation_type] = (relTypeCounts[r.relation_type] || 0) + 1;
        }
      }

      return { elements, relTypeCounts };
    }

    function buildFullElements() {
      const topNodes = Object.entries(degree)
        .sort((a, b) => b[1] - a[1])
        .slice(0, FULL_MAX_NODES)
        .map(([key]) => key);

      const addedNodes = new Set();
      const elements = [];
      const relTypeCounts = {};

      for (const key of topNodes) {
        const e = entityIndex[key];
        if (!e) continue;
        elements.push({ data: { id: key, label: e.name, type: e.type, degree: degree[key] || 0 } });
        addedNodes.add(key);
      }

      // Edges only between actually-added nodes
      for (const r of allRelations) {
        const src = `${r.subj_type}-${r.subj_id}`;
        const tgt = `${r.obj_type}-${r.obj_id}`;
        if (addedNodes.has(src) && addedNodes.has(tgt)) {
          elements.push({ data: { source: src, target: tgt, relType: r.relation_type } });
          relTypeCounts[r.relation_type] = (relTypeCounts[r.relation_type] || 0) + 1;
        }
      }

      return { elements, relTypeCounts };
    }

    function renderGraph(elements, relTypeCounts, layoutName) {
      if (cy) cy.destroy();

      const nodeCount = elements.filter(e => !e.data.source).length;
      const edgeCount = elements.filter(e => e.data.source).length;
      const info = document.getElementById('network-info');

      const layout = layoutName === 'concentric'
        ? {
            name: 'concentric',
            concentric: node => node.data('isCenter') === 'yes' ? 100 : 1,
            levelWidth: () => 1,
            animate: false,
            minNodeSpacing: 25,
          }
        : {
            name: 'cose',
            animate: false,
            nodeRepulsion: 18000,
            idealEdgeLength: 80,
            gravity: 0.25,
            numIter: 400,
          };

      cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: cyStyles,
        layout: layout,
      });

      // Update info
      if (currentMode === 'ego') {
        const centerName = entityIndex[currentCenter]?.name || currentCenter;
        info.textContent = `Ego-Netzwerk: ${nodeCount} Knoten, ${formatNumber(edgeCount)} Kanten um ${centerName}`;
        document.getElementById('network-subtitle').textContent = `Direktes Beziehungsnetzwerk um ${centerName}`;
      } else {
        info.textContent = `${nodeCount} Knoten, ${formatNumber(edgeCount)} Kanten (Top-${FULL_MAX_NODES} nach Vernetzungsgrad)`;
        document.getElementById('network-subtitle').textContent = `Top-${FULL_MAX_NODES} vernetzte Entitäten aus der SiCProD-Datenbank`;
      }

      // Update relation type filter
      const relSelect = document.getElementById('filter-reltype');
      relSelect.innerHTML = '<option value="">Alle Relationstypen</option>';
      Object.entries(relTypeCounts)
        .sort((a, b) => b[1] - a[1])
        .forEach(([type, count]) => {
          const opt = document.createElement('option');
          opt.value = type;
          opt.textContent = `${type} (${count})`;
          relSelect.appendChild(opt);
        });

      // Node click
      cy.on('tap', 'node', function(evt) {
        showNodeDetail(evt.target);
      });

      // Background click
      cy.on('tap', function(evt) {
        if (evt.target === cy) {
          document.getElementById('detail-sidebar').style.display = 'none';
          cy.elements().removeClass('highlighted neighbor faded');
        }
      });
    }

    function showNodeDetail(node) {
      cy.elements().removeClass('highlighted neighbor faded').addClass('faded');
      node.removeClass('faded').addClass('highlighted');
      const neighborhood = node.neighborhood();
      neighborhood.removeClass('faded').addClass('neighbor');

      const sidebar = document.getElementById('detail-sidebar');
      sidebar.style.display = 'block';
      document.getElementById('sidebar-name').textContent = node.data('label');

      const connections = neighborhood.nodes().map(n => ({
        name: n.data('label'), type: n.data('type'),
      })).sort((a, b) => a.name.localeCompare(b.name));

      let html = `<div class="detail-panel__field"><span class="detail-panel__label">Typ</span><span class="entity entity--${node.data('type')}">${node.data('type')}</span></div>`;
      html += `<div class="detail-panel__field"><span class="detail-panel__label">Verbindungen</span>${node.data('degree')} gesamt</div>`;
      html += `<div class="detail-panel__field"><span class="detail-panel__label">Nachbarn (${connections.length})</span>`;
      html += connections.slice(0, 20).map(c =>
        `<div class="small"><span class="entity entity--${c.type}" style="font-size:0.6rem">${c.type}</span> ${escapeHTML(c.name)}</div>`
      ).join('');
      if (connections.length > 20) html += `<div class="small text-body-secondary">… und ${connections.length - 20} weitere</div>`;
      html += '</div>';

      html += `<div class="mt-2 d-flex flex-column gap-1">`;
      // "Explore this person's network" button
      const nodeId = node.data('id');
      if (nodeId !== currentCenter || currentMode !== 'ego') {
        html += `<button class="btn btn-outline-accent btn-sm" onclick="document.dispatchEvent(new CustomEvent('explore-node', {detail:'${nodeId}'}))">Netzwerk erkunden</button>`;
      }
      html += `<a href="search.html?q=${encodeURIComponent(node.data('label'))}" class="btn btn-outline-secondary btn-sm">In Suche öffnen</a>`;
      html += `</div>`;

      document.getElementById('sidebar-content').innerHTML = html;
    }

    function switchMode(mode, centerKey) {
      currentMode = mode;
      document.getElementById('btn-ego').classList.toggle('active', mode === 'ego');
      document.getElementById('btn-full').classList.toggle('active', mode === 'full');

      document.getElementById('detail-sidebar').style.display = 'none';
      document.getElementById('node-search').value = '';
      document.getElementById('filter-reltype').value = '';

      if (mode === 'ego') {
        if (centerKey) currentCenter = centerKey;
        const { elements, relTypeCounts } = buildEgoElements(currentCenter);
        renderGraph(elements, relTypeCounts, 'concentric');
      } else {
        const { elements, relTypeCounts } = buildFullElements();
        renderGraph(elements, relTypeCounts, 'cose');
      }
    }

    async function init() {
      const info = document.getElementById('network-info');
      info.textContent = 'Daten werden geladen...';

      try {
        let data;
        try {
          data = await loadAll({
            persons: 'data/persons.json',
            relations: 'data/relations.json',
            places: 'data/places.json',
            institutions: 'data/institutions.json',
            functions: 'data/functions.json',
          });
        } catch {
          info.textContent = 'SiCProD-Daten nicht verfügbar.';
          return;
        }

        info.textContent = 'Netzwerk wird aufgebaut...';

        // Build entity index
        for (const p of data.persons) entityIndex[`person-${p.id}`] = { name: [p.first_name, p.name].filter(Boolean).join(' ') || '(unbekannt)', type: 'person' };
        for (const pl of data.places) entityIndex[`place-${pl.id}`] = { name: pl.label, type: 'place' };
        for (const inst of data.institutions) entityIndex[`institution-${inst.id}`] = { name: inst.name, type: 'institution' };
        for (const f of data.functions) entityIndex[`function-${f.id}`] = { name: f.name, type: 'function' };

        allRelations = data.relations;

        // Build degree map
        for (const r of allRelations) {
          if (r.subj_id) degree[`${r.subj_type}-${r.subj_id}`] = (degree[`${r.subj_type}-${r.subj_id}`] || 0) + 1;
          if (r.obj_id) degree[`${r.obj_type}-${r.obj_id}`] = (degree[`${r.obj_type}-${r.obj_id}`] || 0) + 1;
        }

        // Load Cytoscape
        const cytoscapeModule = await import('./lib/cytoscape.esm.min.mjs');
        cytoscape = cytoscapeModule.default;

        // Check URL params - fall back to Sigmund if person not found
        const params = getParams();
        let highlightFallback = false;
        if (params.highlight) {
          const highlightKey = `person-${params.highlight}`;
          if (entityIndex[highlightKey]) {
            currentCenter = highlightKey;
          } else {
            highlightFallback = true;
          }
        }

        // Default: ego network
        switchMode('ego', currentCenter);

        if (highlightFallback) {
          const info = document.getElementById('network-info');
          const origText = info.textContent;
          info.textContent = `Person nicht im Netzwerk gefunden. Zeige Standardansicht.`;
          info.style.color = 'var(--conf-low, #c0392b)';
          setTimeout(() => { info.textContent = origText; info.style.color = ''; }, 4000);
        }

        // Event listeners
        document.getElementById('btn-ego').addEventListener('click', () => switchMode('ego', currentCenter));
        document.getElementById('btn-full').addEventListener('click', () => switchMode('full'));

        document.getElementById('node-search').addEventListener('input', debounce((e) => {
          const q = e.target.value.toLowerCase().trim();
          if (!q) {
            cy.elements().removeClass('highlighted faded');
            return;
          }
          cy.elements().addClass('faded');
          const matches = cy.nodes().filter(n => n.data('label').toLowerCase().includes(q));
          matches.removeClass('faded').addClass('highlighted');
        }, 200));

        document.getElementById('filter-reltype').addEventListener('change', (e) => {
          const type = e.target.value;
          if (!type) {
            cy.elements().style('display', 'element');
            return;
          }
          cy.edges().forEach(edge => {
            edge.style('display', edge.data('relType') === type ? 'element' : 'none');
          });
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
          switchMode(currentMode, currentMode === 'ego' ? DEFAULT_CENTER : undefined);
        });

        document.getElementById('btn-close-sidebar').addEventListener('click', () => {
          document.getElementById('detail-sidebar').style.display = 'none';
          cy.elements().removeClass('highlighted neighbor faded');
        });

        // Custom event for "explore node" button in sidebar
        document.addEventListener('explore-node', (e) => {
          switchMode('ego', e.detail);
        });

      } catch (err) {
        info.textContent = `Fehler beim Laden des Netzwerks.`;
        console.error(err);
      }
    }

    init();
  </script>
</body>
</html>
